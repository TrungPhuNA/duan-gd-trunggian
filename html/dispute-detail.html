<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi Ti·∫øt Khi·∫øu N·∫°i - SafeTrade</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e0e0e0;
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 24px;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -23px;
            top: 6px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #007BFF;
        }
        
        .timeline-item.completed::before {
            background: #28a745;
        }
        
        .timeline-item.current::before {
            background: #ffc107;
            box-shadow: 0 0 0 4px rgba(255, 193, 7, 0.2);
        }
        
        .timeline-content {
            background: white;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .timeline-title {
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .timeline-time {
            font-size: 12px;
            color: #666;
        }
        
        .evidence-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }
        
        .evidence-item {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .evidence-item:hover {
            border-color: #007BFF;
            background: #e6f3ff;
        }
        
        .admin-response {
            background: #e6f3ff;
            border-left: 4px solid #007BFF;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }
        
        .dispute-actions {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 16px;
            border-top: 1px solid #e0e0e0;
            margin: 0 -16px -16px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <button onclick="history.back()" class="btn btn-secondary" style="padding: 8px 12px;">‚Üê</button>
                    <div class="logo">Chi Ti·∫øt Khi·∫øu N·∫°i</div>
                </div>
                <div class="user-info">
                    <div class="user-name">ƒêang t·∫£i...</div>
                    <div class="user-avatar">üë§</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container" style="padding: 24px 16px 80px;">
        <div id="disputeContent">
            <div class="loading">
                <div class="spinner"></div>
                <p>ƒêang t·∫£i th√¥ng tin khi·∫øu n·∫°i...</p>
            </div>
        </div>
    </main>

    <script src="js/app.js"></script>
    <script>
        let currentDispute = null;
        let currentUser = null;
        let relatedTransaction = null;

        function loadDispute() {
            const urlParams = new URLSearchParams(window.location.search);
            const disputeId = urlParams.get('id');
            
            if (!disputeId) {
                showError('Kh√¥ng t√¨m th·∫•y m√£ khi·∫øu n·∫°i');
                return;
            }

            currentUser = App.User.getCurrentUser();
            currentDispute = App.Dispute.getById(disputeId);
            
            if (!currentDispute) {
                showError('Kh√¥ng t√¨m th·∫•y khi·∫øu n·∫°i');
                return;
            }

            relatedTransaction = App.Transaction.getById(currentDispute.transactionId);
            renderDispute();
        }

        function renderDispute() {
            const container = document.getElementById('disputeContent');
            const isAdmin = currentUser?.role === 'admin';
            const isOwner = currentUser?.id === currentDispute.buyerId || currentUser?.id === currentDispute.sellerId;
            
            container.innerHTML = `
                <!-- Dispute Status -->
                <div class="card mb-24">
                    <div class="card-body text-center">
                        <div style="font-size: 48px; margin-bottom: 16px;">
                            ${getStatusIcon(currentDispute.status)}
                        </div>
                        <h2 style="margin-bottom: 8px;">#${currentDispute.id}</h2>
                        <span class="status-badge ${getStatusClass(currentDispute.status)}" style="font-size: 14px;">
                            ${getStatusText(currentDispute.status)}
                        </span>
                        <div style="margin-top: 16px;">
                            <div class="dispute-type" style="display: inline-block; padding: 6px 12px; background: #e9ecef; border-radius: 6px; font-size: 14px;">
                                ${getTypeText(currentDispute.type)}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dispute Information -->
                <div class="card mb-24">
                    <div class="card-header">üìã Th√¥ng tin khi·∫øu n·∫°i</div>
                    <div class="card-body">
                        <h3 style="margin-bottom: 16px;">${currentDispute.title}</h3>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <div>
                                <strong>Giao d·ªãch li√™n quan:</strong><br>
                                <a href="transaction-detail.html?id=${currentDispute.transactionId}" style="color: #007BFF; text-decoration: none;">
                                    #${currentDispute.transactionId}
                                </a>
                            </div>
                            <div>
                                <strong>Y√™u c·∫ßu gi·∫£i quy·∫øt:</strong><br>
                                ${getResolutionText(currentDispute.resolution)}
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                            <strong>M√¥ t·∫£ chi ti·∫øt:</strong><br>
                            <div style="margin-top: 8px; line-height: 1.6;">
                                ${currentDispute.description}
                            </div>
                        </div>
                        
                        ${relatedTransaction ? `
                            <div style="background: #e6f3ff; padding: 16px; border-radius: 8px; border-left: 4px solid #007BFF;">
                                <strong>Th√¥ng tin giao d·ªãch:</strong><br>
                                <div style="margin-top: 8px;">
                                    <strong>S·∫£n ph·∫©m:</strong> ${relatedTransaction.productName}<br>
                                    <strong>Gi√° tr·ªã:</strong> ${App.Utils.formatCurrency(relatedTransaction.amount)}<br>
                                    <strong>Ng∆∞·ªùi b√°n:</strong> ${relatedTransaction.sellerName} - ${relatedTransaction.sellerPhone}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>

                <!-- Evidence -->
                ${currentDispute.evidence && currentDispute.evidence.length > 0 ? `
                    <div class="card mb-24">
                        <div class="card-header">üì∏ B·∫±ng ch·ª©ng</div>
                        <div class="card-body">
                            <div class="evidence-grid">
                                ${currentDispute.evidence.map(evidence => `
                                    <div class="evidence-item" onclick="viewEvidence('${evidence}')">
                                        <div style="font-size: 24px; margin-bottom: 8px;">üìé</div>
                                        <div style="font-size: 12px; font-weight: 500;">${evidence}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                ` : ''}

                <!-- Timeline -->
                <div class="card mb-24">
                    <div class="card-header">üìÖ L·ªãch s·ª≠ x·ª≠ l√Ω</div>
                    <div class="card-body">
                        <div class="timeline">
                            ${renderTimeline()}
                        </div>
                    </div>
                </div>

                <!-- Admin Response -->
                ${currentDispute.adminResponse ? `
                    <div class="card mb-24">
                        <div class="card-header">üë®‚Äçüíº Ph·∫£n h·ªìi t·ª´ Admin</div>
                        <div class="card-body">
                            <div class="admin-response">
                                <strong>K·∫øt qu·∫£ x·ª≠ l√Ω:</strong><br>
                                <div style="margin-top: 8px; line-height: 1.6;">
                                    ${currentDispute.adminResponse}
                                </div>
                                ${currentDispute.winner ? `
                                    <div style="margin-top: 12px; padding: 8px; background: rgba(40, 167, 69, 0.1); border-radius: 4px;">
                                        <strong>K·∫øt qu·∫£:</strong> ${currentDispute.winner === 'buyer' ? 'üõí Ng∆∞·ªùi mua th·∫Øng ki·ªán' : 'üè™ Ng∆∞·ªùi b√°n th·∫Øng ki·ªán'}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                ` : ''}

                <!-- Actions -->
                ${renderActions(isAdmin, isOwner)}
            `;
        }

        function renderTimeline() {
            const timeline = [
                { 
                    status: 'created', 
                    title: 'Khi·∫øu n·∫°i ƒë∆∞·ª£c t·∫°o', 
                    time: currentDispute.createdAt, 
                    completed: true 
                },
                { 
                    status: 'pending', 
                    title: 'Ch·ªù admin x·ª≠ l√Ω', 
                    time: null, 
                    completed: true,
                    current: currentDispute.status === 'pending'
                },
                { 
                    status: 'investigating', 
                    title: 'Admin ƒëang x·ª≠ l√Ω', 
                    time: null, 
                    completed: ['investigating', 'resolved', 'rejected'].includes(currentDispute.status),
                    current: currentDispute.status === 'investigating'
                },
                { 
                    status: 'resolved', 
                    title: currentDispute.status === 'rejected' ? 'Khi·∫øu n·∫°i b·ªã t·ª´ ch·ªëi' : 'Khi·∫øu n·∫°i ƒë∆∞·ª£c gi·∫£i quy·∫øt', 
                    time: ['resolved', 'rejected'].includes(currentDispute.status) ? currentDispute.updatedAt : null, 
                    completed: ['resolved', 'rejected'].includes(currentDispute.status),
                    current: false
                }
            ];

            return timeline.map(item => `
                <div class="timeline-item ${item.completed ? 'completed' : ''} ${item.current ? 'current' : ''}">
                    <div class="timeline-content">
                        <div class="timeline-title">${item.title}</div>
                        ${item.time ? `<div class="timeline-time">${App.Utils.formatDate(item.time)}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function renderActions(isAdmin, isOwner) {
            if (!isAdmin && !isOwner) return '';

            let actions = [];

            if (isAdmin && currentDispute.status === 'pending') {
                actions.push(`
                    <div class="card">
                        <div class="card-header">‚ö° Thao t√°c Admin</div>
                        <div class="card-body">
                            <div style="display: grid; gap: 12px;">
                                <button class="btn btn-primary btn-full" onclick="startInvestigation()">
                                    üîç B·∫Øt ƒë·∫ßu x·ª≠ l√Ω
                                </button>
                                <button class="btn btn-danger btn-full" onclick="rejectDispute()">
                                    ‚ùå T·ª´ ch·ªëi khi·∫øu n·∫°i
                                </button>
                            </div>
                        </div>
                    </div>
                `);
            } else if (isAdmin && currentDispute.status === 'investigating') {
                actions.push(`
                    <div class="card">
                        <div class="card-header">‚öñÔ∏è Ph√¢n x·ª≠</div>
                        <div class="card-body">
                            <div style="display: grid; gap: 12px;">
                                <button class="btn btn-success btn-full" onclick="resolveDispute('buyer')">
                                    ‚úÖ Ng∆∞·ªùi mua th·∫Øng ki·ªán
                                </button>
                                <button class="btn btn-warning btn-full" onclick="resolveDispute('seller')">
                                    ‚úÖ Ng∆∞·ªùi b√°n th·∫Øng ki·ªán
                                </button>
                            </div>
                        </div>
                    </div>
                `);
            } else if (isOwner && ['pending', 'investigating'].includes(currentDispute.status)) {
                actions.push(`
                    <div class="card">
                        <div class="card-header">üìù Th√¥ng tin th√™m</div>
                        <div class="card-body">
                            <p style="margin-bottom: 16px; color: #666; font-size: 14px;">
                                Khi·∫øu n·∫°i ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω. B·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o khi c√≥ k·∫øt qu·∫£.
                            </p>
                            <button class="btn btn-secondary btn-full" onclick="addEvidence()">
                                üìé Th√™m b·∫±ng ch·ª©ng
                            </button>
                        </div>
                    </div>
                `);
            }

            return actions.join('');
        }

        function getStatusIcon(status) {
            const icons = {
                'pending': '‚è≥',
                'investigating': 'üîç',
                'resolved': '‚úÖ',
                'rejected': '‚ùå'
            };
            return icons[status] || 'üìã';
        }

        function getStatusClass(status) {
            const classes = {
                'pending': 'status-pending',
                'investigating': 'status-paid',
                'resolved': 'status-completed',
                'rejected': 'status-disputed'
            };
            return classes[status] || 'status-pending';
        }

        function getStatusText(status) {
            const texts = {
                'pending': 'Ch·ªù x·ª≠ l√Ω',
                'investigating': 'ƒêang x·ª≠ l√Ω',
                'resolved': 'ƒê√£ gi·∫£i quy·∫øt',
                'rejected': 'ƒê√£ t·ª´ ch·ªëi'
            };
            return texts[status] || status;
        }

        function getTypeText(type) {
            const types = {
                'not_received': 'Ch∆∞a nh·∫≠n ƒë∆∞·ª£c h√†ng',
                'wrong_item': 'Sai s·∫£n ph·∫©m',
                'damaged': 'H√†ng b·ªã h·ªèng',
                'fake': 'H√†ng gi·∫£/nh√°i',
                'other': 'Kh√°c'
            };
            return types[type] || type;
        }

        function getResolutionText(resolution) {
            const resolutions = {
                'refund': 'Ho√†n ti·ªÅn',
                'exchange': 'ƒê·ªïi h√†ng',
                'partial_refund': 'Ho√†n m·ªôt ph·∫ßn ti·ªÅn',
                'other': 'Kh√°c'
            };
            return resolutions[resolution] || resolution;
        }

        function showError(message) {
            document.getElementById('disputeContent').innerHTML = `
                <div style="text-align: center; padding: 40px 20px; color: #dc3545;">
                    <div style="font-size: 48px; margin-bottom: 16px;">‚ùå</div>
                    <p>${message}</p>
                    <button class="btn btn-primary mt-16" onclick="history.back()">Quay l·∫°i</button>
                </div>
            `;
        }

        // Action handlers
        function viewEvidence(evidence) {
            alert(`Xem b·∫±ng ch·ª©ng: ${evidence}\n\nT√≠nh nƒÉng n√†y s·∫Ω ƒë∆∞·ª£c ph√°t tri·ªÉn ƒë·ªÉ hi·ªÉn th·ªã h√¨nh ·∫£nh/video th·ª±c t·∫ø.`);
        }

        function startInvestigation() {
            if (confirm('B·∫Øt ƒë·∫ßu x·ª≠ l√Ω khi·∫øu n·∫°i n√†y?')) {
                App.Dispute.update(currentDispute.id, { status: 'investigating' });
                currentDispute.status = 'investigating';
                renderDispute();
                alert('ƒê√£ b·∫Øt ƒë·∫ßu x·ª≠ l√Ω khi·∫øu n·∫°i.');
            }
        }

        function rejectDispute() {
            const reason = prompt('L√Ω do t·ª´ ch·ªëi khi·∫øu n·∫°i:');
            if (reason) {
                App.Dispute.update(currentDispute.id, { 
                    status: 'rejected',
                    adminResponse: reason
                });
                currentDispute.status = 'rejected';
                currentDispute.adminResponse = reason;
                renderDispute();
                alert('ƒê√£ t·ª´ ch·ªëi khi·∫øu n·∫°i.');
            }
        }

        function resolveDispute(winner) {
            const winnerText = winner === 'buyer' ? 'Ng∆∞·ªùi mua' : 'Ng∆∞·ªùi b√°n';
            
            if (confirm(`X√°c nh·∫≠n ${winnerText} th·∫Øng ki·ªán?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.`)) {
                const response = prompt('Ghi ch√∫ k·∫øt qu·∫£ ph√¢n x·ª≠:');
                if (response) {
                    App.Dispute.update(currentDispute.id, { 
                        status: 'resolved',
                        winner: winner,
                        adminResponse: response
                    });
                    
                    // Update transaction status
                    if (winner === 'buyer') {
                        App.Transaction.update(currentDispute.transactionId, { status: 'REFUNDED' });
                    } else {
                        App.Transaction.update(currentDispute.transactionId, { status: 'COMPLETED' });
                    }
                    
                    currentDispute.status = 'resolved';
                    currentDispute.winner = winner;
                    currentDispute.adminResponse = response;
                    renderDispute();
                    alert(`ƒê√£ ph√¢n x·ª≠ cho ${winnerText} th·∫Øng ki·ªán.`);
                }
            }
        }

        function addEvidence() {
            const evidence = prompt('T√™n file b·∫±ng ch·ª©ng (v√≠ d·ª•: evidence_new.jpg):');
            if (evidence) {
                const updatedEvidence = [...(currentDispute.evidence || []), evidence];
                App.Dispute.update(currentDispute.id, { evidence: updatedEvidence });
                currentDispute.evidence = updatedEvidence;
                renderDispute();
                alert('ƒê√£ th√™m b·∫±ng ch·ª©ng th√†nh c√¥ng.');
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            const user = App.User.getCurrentUser();
            if (user) {
                document.querySelector('.user-name').textContent = user.name;
                loadDispute();
            }
        });
    </script>
</body>
</html>
