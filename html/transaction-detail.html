<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi Ti·∫øt Giao D·ªãch - SafeTrade</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <button onclick="history.back()" class="btn btn-secondary" style="padding: 8px 12px;">‚Üê</button>
                    <div class="logo">Chi Ti·∫øt Giao D·ªãch</div>
                </div>
                <div class="user-info">
                    <div class="user-name">ƒêang t·∫£i...</div>
                    <div class="user-avatar">üë§</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container" style="padding: 24px 16px 80px;">
        <div id="transactionContent">
            <div class="loading">
                <div class="spinner"></div>
                <p>ƒêang t·∫£i th√¥ng tin giao d·ªãch...</p>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="buyer-dashboard.html" class="bottom-nav-item">
            <span class="bottom-nav-icon">üè†</span>
            <span>Trang ch·ªß</span>
        </a>
        <a href="create-transaction.html" class="bottom-nav-item">
            <span class="bottom-nav-icon">‚ûï</span>
            <span>T·∫°o m·ªõi</span>
        </a>
        <a href="#" class="bottom-nav-item">
            <span class="bottom-nav-icon">‚è≥</span>
            <span>ƒêang ch·ªù</span>
        </a>
        <a href="#" class="bottom-nav-item">
            <span class="bottom-nav-icon">üë§</span>
            <span>T√†i kho·∫£n</span>
        </a>
    </nav>

    <script src="js/app.js"></script>
    <script>
        let currentTransaction = null;
        let currentUser = null;

        function loadTransaction() {
            const urlParams = new URLSearchParams(window.location.search);
            const transactionId = urlParams.get('id');
            
            if (!transactionId) {
                showError('Kh√¥ng t√¨m th·∫•y m√£ giao d·ªãch');
                return;
            }

            currentUser = App.User.getCurrentUser();
            currentTransaction = App.Transaction.getById(transactionId);
            
            if (!currentTransaction) {
                showError('Kh√¥ng t√¨m th·∫•y giao d·ªãch');
                return;
            }

            renderTransaction();
        }

        function renderTransaction() {
            const container = document.getElementById('transactionContent');
            const isUserBuyer = currentUser.id === currentTransaction.buyerId;
            const userRole = isUserBuyer ? 'buyer' : 'seller';
            
            container.innerHTML = `
                <!-- Transaction Status -->
                <div class="card mb-24">
                    <div class="card-body text-center">
                        <div style="font-size: 48px; margin-bottom: 16px;">
                            ${getStatusIcon(currentTransaction.status)}
                        </div>
                        <h2 style="margin-bottom: 8px;">#${currentTransaction.id}</h2>
                        <span class="status-badge ${getStatusClass(currentTransaction.status)}" style="font-size: 14px;">
                            ${getStatusText(currentTransaction.status)}
                        </span>
                        <div style="margin-top: 16px; font-size: 24px; font-weight: bold; color: #28a745;">
                            ${App.Utils.formatCurrency(currentTransaction.amount)}
                        </div>
                    </div>
                </div>

                <!-- Product Information -->
                <div class="card mb-24">
                    <div class="card-header">üì¶ Th√¥ng tin s·∫£n ph·∫©m</div>
                    <div class="card-body">
                        <h3 style="margin-bottom: 12px;">${currentTransaction.productName}</h3>
                        ${currentTransaction.productDescription ? `
                            <p style="color: #666; margin-bottom: 16px;">${currentTransaction.productDescription}</p>
                        ` : ''}
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                <span>S·ªë ti·ªÅn giao d·ªãch:</span>
                                <span>${App.Utils.formatCurrency(currentTransaction.amount)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                <span>Ph√≠ d·ªãch v·ª• (2%):</span>
                                <span>${App.Utils.formatCurrency(currentTransaction.amount * 0.02)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-weight: bold; border-top: 1px solid #e0e0e0; padding-top: 4px;">
                                <span>Ng∆∞·ªùi b√°n nh·∫≠n ƒë∆∞·ª£c:</span>
                                <span>${App.Utils.formatCurrency(currentTransaction.amount * 0.98)}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Parties Information -->
                <div class="card mb-24">
                    <div class="card-header">üë• Th√¥ng tin c√°c b√™n</div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <h4 style="margin-bottom: 8px; color: #667eea;">üõí Ng∆∞·ªùi mua</h4>
                                <p style="margin: 4px 0;"><strong>${currentTransaction.buyerName || 'N/A'}</strong></p>
                                <p style="margin: 4px 0; color: #666;">${currentTransaction.buyerPhone || 'N/A'}</p>
                            </div>
                            <div>
                                <h4 style="margin-bottom: 8px; color: #28a745;">üè™ Ng∆∞·ªùi b√°n</h4>
                                <p style="margin: 4px 0;"><strong>${currentTransaction.sellerName}</strong></p>
                                <p style="margin: 4px 0; color: #666;">${currentTransaction.sellerPhone}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Timeline -->
                <div class="card mb-24">
                    <div class="card-header">üìÖ L·ªãch s·ª≠ giao d·ªãch</div>
                    <div class="card-body">
                        ${renderTimeline()}
                    </div>
                </div>

                <!-- Actions -->
                <div class="card mb-24">
                    <div class="card-header">‚ö° Thao t√°c</div>
                    <div class="card-body">
                        ${renderActions(userRole)}
                    </div>
                </div>

                ${currentTransaction.notes ? `
                    <div class="card mb-24">
                        <div class="card-header">üìù Ghi ch√∫</div>
                        <div class="card-body">
                            <p>${currentTransaction.notes}</p>
                        </div>
                    </div>
                ` : ''}
            `;
        }

        function renderTimeline() {
            const timeline = [
                { status: 'CREATED', text: 'Giao d·ªãch ƒë∆∞·ª£c t·∫°o', date: currentTransaction.createdAt, completed: true },
                { status: 'PENDING_SELLER', text: 'Ch·ªù ng∆∞·ªùi b√°n x√°c nh·∫≠n', date: null, completed: true },
                { status: 'PENDING_PAYMENT', text: 'Ch·ªù thanh to√°n', date: null, completed: false },
                { status: 'PAID', text: 'ƒê√£ thanh to√°n', date: null, completed: false },
                { status: 'SHIPPING', text: 'ƒêang giao h√†ng', date: null, completed: false },
                { status: 'COMPLETED', text: 'Ho√†n t·∫•t', date: null, completed: false }
            ];

            const currentStatusIndex = timeline.findIndex(t => t.status === currentTransaction.status);
            
            return timeline.map((item, index) => {
                const isCompleted = index <= currentStatusIndex;
                const isCurrent = index === currentStatusIndex;
                
                return `
                    <div style="display: flex; align-items: center; margin-bottom: 12px; ${index === timeline.length - 1 ? 'margin-bottom: 0;' : ''}">
                        <div style="width: 20px; height: 20px; border-radius: 50%; background: ${isCompleted ? '#28a745' : '#e0e0e0'}; margin-right: 12px; display: flex; align-items: center; justify-content: center;">
                            ${isCompleted ? '‚úì' : ''}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: ${isCurrent ? 'bold' : 'normal'}; color: ${isCurrent ? '#667eea' : '#333'};">
                                ${item.text}
                            </div>
                            ${item.date ? `<div style="font-size: 12px; color: #666;">${App.Utils.formatDate(item.date)}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderActions(userRole) {
            const status = currentTransaction.status;
            let actions = [];

            if (userRole === 'buyer') {
                switch (status) {
                    case 'PENDING_SELLER':
                        actions.push(`
                            <div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                                <p style="margin: 0; color: #856404;">‚è≥ ƒêang ch·ªù ng∆∞·ªùi b√°n x√°c nh·∫≠n giao d·ªãch</p>
                            </div>
                        `);
                        break;
                    case 'PENDING_PAYMENT':
                        actions.push(`
                            <button class="btn btn-primary btn-full mb-16" onclick="proceedToPayment()">
                                üí≥ Thanh to√°n ngay
                            </button>
                        `);
                        break;
                    case 'PAID':
                        actions.push(`
                            <div style="background: #d4edda; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                                <p style="margin: 0; color: #155724;">‚úÖ ƒê√£ thanh to√°n. ƒêang ch·ªù ng∆∞·ªùi b√°n g·ª≠i h√†ng</p>
                            </div>
                        `);
                        break;
                    case 'SHIPPING':
                        actions.push(`
                            <button class="btn btn-success btn-full mb-16" onclick="confirmReceived()">
                                ‚úÖ X√°c nh·∫≠n ƒë√£ nh·∫≠n h√†ng
                            </button>
                        `);
                        break;
                    case 'COMPLETED':
                        actions.push(`
                            <div style="background: #d1ecf1; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                                <p style="margin: 0; color: #0c5460;">üéâ Giao d·ªãch ƒë√£ ho√†n t·∫•t th√†nh c√¥ng!</p>
                            </div>
                        `);
                        break;
                }

                // Add dispute option for certain statuses
                if (['PAID', 'SHIPPING'].includes(status)) {
                    actions.push(`
                        <button class="btn btn-warning btn-full" onclick="createDispute()">
                            ‚ö†Ô∏è T·∫°o khi·∫øu n·∫°i
                        </button>
                    `);
                }
            } else {
                // Seller actions
                switch (status) {
                    case 'PENDING_SELLER':
                        actions.push(`
                            <button class="btn btn-success btn-full mb-16" onclick="confirmTransaction()">
                                ‚úÖ X√°c nh·∫≠n giao d·ªãch
                            </button>
                            <button class="btn btn-danger btn-full" onclick="rejectTransaction()">
                                ‚ùå T·ª´ ch·ªëi giao d·ªãch
                            </button>
                        `);
                        break;
                    case 'PENDING_PAYMENT':
                        actions.push(`
                            <div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                                <p style="margin: 0; color: #856404;">‚è≥ ƒêang ch·ªù ng∆∞·ªùi mua thanh to√°n</p>
                            </div>
                        `);
                        break;
                    case 'PAID':
                        actions.push(`
                            <button class="btn btn-primary btn-full" onclick="markAsShipping()">
                                üöö X√°c nh·∫≠n ƒë√£ g·ª≠i h√†ng
                            </button>
                        `);
                        break;
                    case 'SHIPPING':
                        actions.push(`
                            <div style="background: #e2e3e5; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                                <p style="margin: 0; color: #383d41;">üì¶ ƒêang ch·ªù ng∆∞·ªùi mua x√°c nh·∫≠n nh·∫≠n h√†ng</p>
                            </div>
                        `);
                        break;
                    case 'COMPLETED':
                        actions.push(`
                            <div style="background: #d1ecf1; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                                <p style="margin: 0; color: #0c5460;">üéâ Giao d·ªãch ƒë√£ ho√†n t·∫•t. Ti·ªÅn ƒë√£ ƒë∆∞·ª£c chuy·ªÉn!</p>
                            </div>
                        `);
                        break;
                }
            }

            return actions.join('');
        }

        function getStatusIcon(status) {
            const icons = {
                'PENDING_SELLER': '‚è≥',
                'PENDING_PAYMENT': 'üí≥',
                'PAID': '‚úÖ',
                'SHIPPING': 'üöö',
                'COMPLETED': 'üéâ',
                'DISPUTED': '‚ö†Ô∏è'
            };
            return icons[status] || 'üìã';
        }

        function getStatusClass(status) {
            const statusClasses = {
                'PENDING_SELLER': 'status-pending',
                'PENDING_PAYMENT': 'status-pending',
                'PAID': 'status-paid',
                'SHIPPING': 'status-shipping',
                'COMPLETED': 'status-completed',
                'DISPUTED': 'status-disputed'
            };
            return statusClasses[status] || 'status-pending';
        }

        function getStatusText(status) {
            return App.CONFIG.TRANSACTION_STATUSES[status] || status;
        }

        function showError(message) {
            document.getElementById('transactionContent').innerHTML = `
                <div style="text-align: center; padding: 40px 20px; color: #dc3545;">
                    <div style="font-size: 48px; margin-bottom: 16px;">‚ùå</div>
                    <p>${message}</p>
                    <button class="btn btn-primary mt-16" onclick="history.back()">Quay l·∫°i</button>
                </div>
            `;
        }

        // Action handlers
        function proceedToPayment() {
            window.location.href = `payment.html?id=${currentTransaction.id}`;
        }

        function confirmReceived() {
            if (confirm('X√°c nh·∫≠n b·∫°n ƒë√£ nh·∫≠n ƒë∆∞·ª£c h√†ng v√† h√†i l√≤ng v·ªõi s·∫£n ph·∫©m?')) {
                updateTransactionStatus('COMPLETED');
                alert('C·∫£m ∆°n b·∫°n! Giao d·ªãch ƒë√£ ho√†n t·∫•t th√†nh c√¥ng.');
            }
        }

        function createDispute() {
            window.location.href = `dispute.html?id=${currentTransaction.id}`;
        }

        function confirmTransaction() {
            if (confirm('X√°c nh·∫≠n th√¥ng tin giao d·ªãch ch√≠nh x√°c v√† b·∫°n s·∫µn s√†ng giao h√†ng?')) {
                updateTransactionStatus('PENDING_PAYMENT');
                alert('ƒê√£ x√°c nh·∫≠n giao d·ªãch. Ng∆∞·ªùi mua s·∫Ω nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o ƒë·ªÉ thanh to√°n.');
            }
        }

        function rejectTransaction() {
            const reason = prompt('Vui l√≤ng nh·∫≠p l√Ω do t·ª´ ch·ªëi:');
            if (reason) {
                alert('ƒê√£ t·ª´ ch·ªëi giao d·ªãch. Ng∆∞·ªùi mua s·∫Ω nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o.');
                history.back();
            }
        }

        function markAsShipping() {
            if (confirm('X√°c nh·∫≠n b·∫°n ƒë√£ g·ª≠i h√†ng cho ng∆∞·ªùi mua?')) {
                updateTransactionStatus('SHIPPING');
                alert('ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i giao h√†ng. Ng∆∞·ªùi mua s·∫Ω nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o.');
            }
        }

        function updateTransactionStatus(newStatus) {
            App.Transaction.update(currentTransaction.id, { status: newStatus });
            currentTransaction.status = newStatus;
            renderTransaction();
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            const user = App.User.getCurrentUser();
            if (user) {
                document.querySelector('.user-name').textContent = user.name;
                loadTransaction();
            }
        });
    </script>
</body>
</html>
