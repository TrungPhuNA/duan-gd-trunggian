<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Ng∆∞·ªùi B√°n - SafeTrade</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">SafeTrade</div>
                <div class="user-info">
                    <div class="user-details">
                        <div class="user-name">ƒêang t·∫£i...</div>
                        <div class="user-role" style="font-size: 12px; opacity: 0.8;">Ng∆∞·ªùi b√°n</div>
                    </div>
                    <div class="user-avatar">üè™</div>
                    <button class="btn btn-secondary" onclick="App.User.logout()" style="margin-left: 12px; padding: 8px 16px; font-size: 14px;">ƒêƒÉng xu·∫•t</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav">
        <div class="container">
            <ul class="nav-list">
                <li class="nav-item">
                    <a href="seller-dashboard.html" class="nav-link active">Trang ch·ªß</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="filterTransactions('all')">T·∫•t c·∫£</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="filterTransactions('pending')">C·∫ßn x·ª≠ l√Ω</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="filterTransactions('completed')">Ho√†n t·∫•t</a>
                </li>
                <li class="nav-item">
                    <a href="rooms.html" class="nav-link">Ph√≤ng GD</a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container" style="padding-bottom: 80px;">
        <!-- Stats Cards -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin: 24px 0;">
            <div class="card">
                <div class="card-body text-center">
                    <div style="font-size: 24px; font-weight: bold; color: #007BFF;" id="totalTransactions">0</div>
                    <div style="font-size: 14px; color: #666;">T·ªïng giao d·ªãch</div>
                </div>
            </div>
            <div class="card">
                <div class="card-body text-center">
                    <div style="font-size: 24px; font-weight: bold; color: #ffc107;" id="pendingTransactions">0</div>
                    <div style="font-size: 14px; color: #666;">C·∫ßn x·ª≠ l√Ω</div>
                </div>
            </div>
            <div class="card">
                <div class="card-body text-center">
                    <div style="font-size: 24px; font-weight: bold; color: #28a745;" id="completedTransactions">0</div>
                    <div style="font-size: 14px; color: #666;">Ho√†n th√†nh</div>
                </div>
            </div>
            <div class="card">
                <div class="card-body text-center">
                    <div style="font-size: 18px; font-weight: bold; color: #28a745;" id="totalEarnings">0ƒë</div>
                    <div style="font-size: 14px; color: #666;">Thu nh·∫≠p</div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card mb-24">
            <div class="card-header">Thao t√°c nhanh</div>
            <div class="card-body">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                    <button class="btn btn-primary" onclick="filterTransactions('pending')">
                        ‚è≥ Xem giao d·ªãch c·∫ßn x·ª≠ l√Ω
                    </button>
                    <button class="btn btn-secondary" onclick="refreshTransactions()">
                        üîÑ L√†m m·ªõi
                    </button>
                    <a href="rooms.html" class="btn btn-success">
                        üè¢ Qu·∫£n l√Ω ph√≤ng
                    </a>
                </div>
            </div>
        </div>

        <!-- Priority Notifications -->
        <div id="priorityNotifications"></div>

        <!-- Transactions List -->
        <div class="card">
            <div class="card-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Giao d·ªãch c·ªßa t√¥i</span>
                    <select id="statusFilter" class="form-control" style="width: auto; min-width: 150px;" onchange="filterTransactions(this.value)">
                        <option value="all">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                        <option value="pending">C·∫ßn x·ª≠ l√Ω</option>
                        <option value="PENDING_SELLER">Ch·ªù x√°c nh·∫≠n</option>
                        <option value="PENDING_PAYMENT">Ch·ªù thanh to√°n</option>
                        <option value="PAID">ƒê√£ thanh to√°n</option>
                        <option value="SHIPPING">ƒêang giao</option>
                        <option value="COMPLETED">Ho√†n t·∫•t</option>
                        <option value="DISPUTED">Tranh ch·∫•p</option>
                    </select>
                </div>
            </div>
            <div class="card-body" style="padding: 0;">
                <div id="transactionsList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>ƒêang t·∫£i giao d·ªãch...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="seller-dashboard.html" class="bottom-nav-item active">
            <span class="bottom-nav-icon">üè†</span>
            <span>Trang ch·ªß</span>
        </a>
        <a href="#" class="bottom-nav-item" onclick="filterTransactions('pending')">
            <span class="bottom-nav-icon">‚è≥</span>
            <span>C·∫ßn x·ª≠ l√Ω</span>
        </a>
        <a href="rooms.html" class="bottom-nav-item">
            <span class="bottom-nav-icon">üè¢</span>
            <span>Ph√≤ng GD</span>
        </a>
        <a href="#" class="bottom-nav-item" onclick="showProfile()">
            <span class="bottom-nav-icon">üë§</span>
            <span>T√†i kho·∫£n</span>
        </a>
    </nav>

    <script src="js/app.js"></script>
    <script>
        let currentFilter = 'all';
        let allTransactions = [];

        function loadTransactions() {
            const user = App.User.getCurrentUser();
            if (!user) return;

            // For demo, we'll create some mock transactions for seller
            const mockSellerTransactions = [
                {
                    id: 'TXN003',
                    buyerId: 'buyer2',
                    buyerName: 'L√™ VƒÉn C',
                    buyerPhone: '0912345678',
                    sellerId: user.id,
                    sellerName: user.name,
                    sellerPhone: user.phone,
                    productName: 'Samsung Galaxy S24',
                    productDescription: 'M√°y m·ªõi nguy√™n seal, ch∆∞a k√≠ch ho·∫°t',
                    amount: 22000000,
                    status: 'PENDING_SELLER',
                    createdAt: new Date('2024-01-16T09:15:00'),
                    updatedAt: new Date('2024-01-16T09:15:00')
                },
                {
                    id: 'TXN004',
                    buyerId: 'buyer3',
                    buyerName: 'Ph·∫°m Th·ªã D',
                    buyerPhone: '0923456789',
                    sellerId: user.id,
                    sellerName: user.name,
                    sellerPhone: user.phone,
                    productName: 'iPad Pro 12.9',
                    productDescription: 'iPad Pro 2023, 256GB, WiFi + Cellular',
                    amount: 30000000,
                    status: 'PAID',
                    createdAt: new Date('2024-01-15T16:30:00'),
                    updatedAt: new Date('2024-01-15T18:45:00')
                }
            ];

            // Merge with existing transactions
            const existingTransactions = App.Transaction.getAll();
            const userTransactions = existingTransactions.filter(t => t.sellerId === user.id);
            
            // Add mock transactions if not exist
            mockSellerTransactions.forEach(mockTx => {
                if (!existingTransactions.find(t => t.id === mockTx.id)) {
                    existingTransactions.push(mockTx);
                }
            });
            
            App.Storage.set('transactions', existingTransactions);
            allTransactions = App.Transaction.getByUser(user.id, 'seller');
            
            updateStats();
            renderTransactions(allTransactions);
            showPriorityNotifications();
        }

        function updateStats() {
            const total = allTransactions.length;
            const pending = allTransactions.filter(t => 
                ['PENDING_SELLER', 'PAID'].includes(t.status)
            ).length;
            const completed = allTransactions.filter(t => t.status === 'COMPLETED').length;
            const totalEarnings = allTransactions
                .filter(t => t.status === 'COMPLETED')
                .reduce((sum, t) => sum + (t.amount * 0.98), 0); // 98% after 2% fee

            document.getElementById('totalTransactions').textContent = total;
            document.getElementById('pendingTransactions').textContent = pending;
            document.getElementById('completedTransactions').textContent = completed;
            document.getElementById('totalEarnings').textContent = App.Utils.formatCurrency(totalEarnings);
        }

        function showPriorityNotifications() {
            const container = document.getElementById('priorityNotifications');
            const urgentTransactions = allTransactions.filter(t => 
                ['PENDING_SELLER', 'PAID'].includes(t.status)
            );

            if (urgentTransactions.length === 0) {
                container.innerHTML = '';
                return;
            }

            const notifications = urgentTransactions.map(tx => {
                let message = '';
                let actionText = '';
                let actionClass = 'btn-primary';
                
                if (tx.status === 'PENDING_SELLER') {
                    message = `Giao d·ªãch #${tx.id} c·∫ßn x√°c nh·∫≠n`;
                    actionText = 'X√°c nh·∫≠n ngay';
                } else if (tx.status === 'PAID') {
                    message = `Giao d·ªãch #${tx.id} ƒë√£ thanh to√°n, c·∫ßn g·ª≠i h√†ng`;
                    actionText = 'X√°c nh·∫≠n g·ª≠i h√†ng';
                    actionClass = 'btn-success';
                }

                return `
                    <div class="card mb-16" style="border-left: 4px solid #ffc107;">
                        <div class="card-body">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #856404;">‚ö†Ô∏è ${message}</div>
                                    <div style="font-size: 14px; color: #666; margin-top: 4px;">
                                        ${tx.productName} - ${App.Utils.formatCurrency(tx.amount)}
                                    </div>
                                </div>
                                <button class="btn ${actionClass}" onclick="viewTransaction('${tx.id}')" style="padding: 8px 16px; font-size: 14px;">
                                    ${actionText}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = notifications;
        }

        function renderTransactions(transactions) {
            const container = document.getElementById('transactionsList');
            
            if (transactions.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üì¶</div>
                        <p>Ch∆∞a c√≥ giao d·ªãch n√†o</p>
                        <p style="font-size: 14px; margin-top: 8px;">
                            Giao d·ªãch s·∫Ω xu·∫•t hi·ªán khi c√≥ ng∆∞·ªùi mua t·∫°o ƒë∆°n v·ªõi th√¥ng tin c·ªßa b·∫°n
                        </p>
                    </div>
                `;
                return;
            }

            const html = transactions.map(transaction => {
                const isUrgent = ['PENDING_SELLER', 'PAID'].includes(transaction.status);
                
                return `
                    <div class="transaction-item ${isUrgent ? 'urgent' : ''}" onclick="viewTransaction('${transaction.id}')" style="${isUrgent ? 'border-left: 4px solid #ffc107;' : ''}">
                        <div class="transaction-header">
                            <div class="transaction-id">
                                #${transaction.id}
                                ${isUrgent ? '<span style="color: #ffc107; margin-left: 8px;">‚ö†Ô∏è</span>' : ''}
                            </div>
                            <div class="transaction-amount">${App.Utils.formatCurrency(transaction.amount)}</div>
                        </div>
                        <div class="transaction-details">
                            <strong>${transaction.productName}</strong><br>
                            Ng∆∞·ªùi mua: ${transaction.buyerName} - ${transaction.buyerPhone}
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                            <span class="status-badge ${getStatusClass(transaction.status)}">
                                ${getStatusText(transaction.status)}
                            </span>
                            <span style="font-size: 12px; color: #999;">
                                ${App.Utils.formatDate(transaction.updatedAt)}
                            </span>
                        </div>
                        ${renderQuickActions(transaction)}
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        function renderQuickActions(transaction) {
            if (transaction.status === 'PENDING_SELLER') {
                return `
                    <div style="margin-top: 12px; display: flex; gap: 8px;">
                        <button class="btn btn-success" onclick="event.stopPropagation(); quickConfirm('${transaction.id}')" style="flex: 1; padding: 8px; font-size: 14px;">
                            ‚úÖ X√°c nh·∫≠n
                        </button>
                        <button class="btn btn-danger" onclick="event.stopPropagation(); quickReject('${transaction.id}')" style="flex: 1; padding: 8px; font-size: 14px;">
                            ‚ùå T·ª´ ch·ªëi
                        </button>
                    </div>
                `;
            } else if (transaction.status === 'PAID') {
                return `
                    <div style="margin-top: 12px;">
                        <button class="btn btn-primary btn-full" onclick="event.stopPropagation(); quickShip('${transaction.id}')" style="padding: 8px; font-size: 14px;">
                            üöö X√°c nh·∫≠n ƒë√£ g·ª≠i h√†ng
                        </button>
                    </div>
                `;
            }
            return '';
        }

        function getStatusClass(status) {
            const statusClasses = {
                'PENDING_SELLER': 'status-pending',
                'PENDING_PAYMENT': 'status-pending',
                'PAID': 'status-paid',
                'SHIPPING': 'status-shipping',
                'COMPLETED': 'status-completed',
                'DISPUTED': 'status-disputed'
            };
            return statusClasses[status] || 'status-pending';
        }

        function getStatusText(status) {
            return App.CONFIG.TRANSACTION_STATUSES[status] || status;
        }

        function filterTransactions(filter) {
            currentFilter = filter;
            
            let filteredTransactions = allTransactions;
            
            if (filter !== 'all') {
                if (filter === 'pending') {
                    filteredTransactions = allTransactions.filter(t => 
                        ['PENDING_SELLER', 'PAID'].includes(t.status)
                    );
                } else if (filter === 'completed') {
                    filteredTransactions = allTransactions.filter(t => t.status === 'COMPLETED');
                } else {
                    filteredTransactions = allTransactions.filter(t => t.status === filter);
                }
            }
            
            renderTransactions(filteredTransactions);
            
            // Update filter select
            document.getElementById('statusFilter').value = filter;
        }

        function viewTransaction(transactionId) {
            window.location.href = `transaction-detail.html?id=${transactionId}`;
        }

        function quickConfirm(transactionId) {
            if (confirm('X√°c nh·∫≠n giao d·ªãch n√†y?')) {
                App.Transaction.update(transactionId, { status: 'PENDING_PAYMENT' });
                loadTransactions();
                filterTransactions(currentFilter);
                alert('ƒê√£ x√°c nh·∫≠n giao d·ªãch. Ng∆∞·ªùi mua s·∫Ω nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o ƒë·ªÉ thanh to√°n.');
            }
        }

        function quickReject(transactionId) {
            const reason = prompt('L√Ω do t·ª´ ch·ªëi:');
            if (reason) {
                alert('ƒê√£ t·ª´ ch·ªëi giao d·ªãch. Ng∆∞·ªùi mua s·∫Ω nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o.');
                // In real app, would update status to REJECTED
                loadTransactions();
                filterTransactions(currentFilter);
            }
        }

        function quickShip(transactionId) {
            if (confirm('X√°c nh·∫≠n b·∫°n ƒë√£ g·ª≠i h√†ng?')) {
                App.Transaction.update(transactionId, { status: 'SHIPPING' });
                loadTransactions();
                filterTransactions(currentFilter);
                alert('ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i giao h√†ng. Ng∆∞·ªùi mua s·∫Ω nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o.');
            }
        }

        function refreshTransactions() {
            App.Utils.showLoading(document.getElementById('transactionsList'));
            setTimeout(() => {
                loadTransactions();
                filterTransactions(currentFilter);
            }, 1000);
        }

        function showEarnings() {
            const completedTransactions = allTransactions.filter(t => t.status === 'COMPLETED');
            const totalEarnings = completedTransactions.reduce((sum, t) => sum + (t.amount * 0.98), 0);
            
            let message = `üí∞ T·ªïng thu nh·∫≠p: ${App.Utils.formatCurrency(totalEarnings)}\n\n`;
            message += `üìä Chi ti·∫øt:\n`;
            message += `- Giao d·ªãch ho√†n th√†nh: ${completedTransactions.length}\n`;
            message += `- Ph√≠ d·ªãch v·ª• (2%): ${App.Utils.formatCurrency(completedTransactions.reduce((sum, t) => sum + (t.amount * 0.02), 0))}\n`;
            message += `- Thu nh·∫≠p r√≤ng: ${App.Utils.formatCurrency(totalEarnings)}`;
            
            alert(message);
        }

        function showProfile() {
            const user = App.User.getCurrentUser();
            alert(`Th√¥ng tin t√†i kho·∫£n:\nT√™n: ${user.name}\nSƒêT: ${user.phone}\nVai tr√≤: Ng∆∞·ªùi b√°n`);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            const user = App.User.getCurrentUser();
            if (user) {
                document.querySelector('.user-name').textContent = user.name;
                loadTransactions();
            }
        });
    </script>
</body>
</html>
