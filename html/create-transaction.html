<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T·∫°o Giao D·ªãch M·ªõi - SafeTrade</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <button onclick="history.back()" class="btn btn-secondary" style="padding: 8px 12px;">‚Üê</button>
                    <div class="logo">T·∫°o Giao D·ªãch M·ªõi</div>
                </div>
                <div class="user-info">
                    <div class="user-name">ƒêang t·∫£i...</div>
                    <div class="user-avatar">üë§</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container" style="padding: 24px 16px 80px;">
        <form id="createTransactionForm">
            <!-- Seller Information -->
            <div class="card mb-24">
                <div class="card-header">
                    <span>üë§ Th√¥ng tin ng∆∞·ªùi b√°n</span>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">T√™n ng∆∞·ªùi b√°n *</label>
                        <input type="text" class="form-control" id="sellerName" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi b√°n" required>
                        <div class="error-message" id="sellerNameError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">S·ªë ƒëi·ªán tho·∫°i ng∆∞·ªùi b√°n *</label>
                        <input type="tel" class="form-control" id="sellerPhone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" required>
                        <div class="error-message" id="sellerPhoneError"></div>
                    </div>
                </div>
            </div>

            <!-- Product Information -->
            <div class="card mb-24">
                <div class="card-header">
                    <span>üì¶ Th√¥ng tin s·∫£n ph·∫©m</span>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">T√™n s·∫£n ph·∫©m *</label>
                        <input type="text" class="form-control" id="productName" placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m" required>
                        <div class="error-message" id="productNameError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">M√¥ t·∫£ s·∫£n ph·∫©m</label>
                        <textarea class="form-control" id="productDescription" rows="4" placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ s·∫£n ph·∫©m (t√¨nh tr·∫°ng, b·∫£o h√†nh, ph·ª• ki·ªán...)"></textarea>
                        <div class="error-message" id="productDescriptionError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">S·ªë ti·ªÅn giao d·ªãch *</label>
                        <input type="number" class="form-control" id="amount" placeholder="Nh·∫≠p s·ªë ti·ªÅn (VND)" required min="10000">
                        <div style="font-size: 12px; color: #666; margin-top: 4px;">
                            S·ªë ti·ªÅn t·ªëi thi·ªÉu: 10,000 VND
                        </div>
                        <div class="error-message" id="amountError"></div>
                    </div>
                    
                    <div id="amountDisplay" style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-top: 8px; display: none;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span>S·ªë ti·ªÅn giao d·ªãch:</span>
                            <span id="displayAmount">0 VND</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span>Ph√≠ d·ªãch v·ª• (2%):</span>
                            <span id="displayFee">0 VND</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-weight: bold; border-top: 1px solid #e0e0e0; padding-top: 4px;">
                            <span>Ng∆∞·ªùi b√°n nh·∫≠n ƒë∆∞·ª£c:</span>
                            <span id="displaySellerAmount">0 VND</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Additional Information -->
            <div class="card mb-24">
                <div class="card-header">
                    <span>üìù Th√¥ng tin b·ªï sung</span>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Ghi ch√∫</label>
                        <textarea class="form-control" id="notes" rows="3" placeholder="Ghi ch√∫ th√™m v·ªÅ giao d·ªãch (t√πy ch·ªçn)"></textarea>
                    </div>
                    
                    <div style="background: #e3f2fd; padding: 16px; border-radius: 8px; border-left: 4px solid #2196f3;">
                        <h4 style="margin: 0 0 8px 0; color: #1976d2; font-size: 14px;">‚ÑπÔ∏è L∆∞u √Ω quan tr·ªçng:</h4>
                        <ul style="margin: 0; padding-left: 16px; font-size: 13px; color: #1976d2;">
                            <li>Vui l√≤ng ki·ªÉm tra k·ªπ th√¥ng tin tr∆∞·ªõc khi t·∫°o giao d·ªãch</li>
                            <li>Ng∆∞·ªùi b√°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o v√† c·∫ßn x√°c nh·∫≠n giao d·ªãch</li>
                            <li>B·∫°n ch·ªâ thanh to√°n sau khi ng∆∞·ªùi b√°n x√°c nh·∫≠n</li>
                            <li>Ti·ªÅn s·∫Ω ƒë∆∞·ª£c gi·ªØ an to√†n cho ƒë·∫øn khi giao d·ªãch ho√†n t·∫•t</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="card">
                <div class="card-body">
                    <button type="submit" class="btn btn-primary btn-full" id="submitBtn">
                        üöÄ T·∫°o Giao D·ªãch
                    </button>
                    <button type="button" class="btn btn-secondary btn-full mt-16" onclick="history.back()">
                        H·ªßy b·ªè
                    </button>
                </div>
            </div>
        </form>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="buyer-dashboard.html" class="bottom-nav-item">
            <span class="bottom-nav-icon">üè†</span>
            <span>Trang ch·ªß</span>
        </a>
        <a href="create-transaction.html" class="bottom-nav-item active">
            <span class="bottom-nav-icon">‚ûï</span>
            <span>T·∫°o m·ªõi</span>
        </a>
        <a href="#" class="bottom-nav-item">
            <span class="bottom-nav-icon">‚è≥</span>
            <span>ƒêang ch·ªù</span>
        </a>
        <a href="#" class="bottom-nav-item">
            <span class="bottom-nav-icon">üë§</span>
            <span>T√†i kho·∫£n</span>
        </a>
    </nav>

    <script src="js/app.js"></script>
    <script>
        // Calculate and display amount breakdown
        function updateAmountDisplay() {
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            const fee = amount * 0.02; // 2% fee
            const sellerAmount = amount - fee;
            
            if (amount > 0) {
                document.getElementById('amountDisplay').style.display = 'block';
                document.getElementById('displayAmount').textContent = App.Utils.formatCurrency(amount);
                document.getElementById('displayFee').textContent = App.Utils.formatCurrency(fee);
                document.getElementById('displaySellerAmount').textContent = App.Utils.formatCurrency(sellerAmount);
            } else {
                document.getElementById('amountDisplay').style.display = 'none';
            }
        }

        // Form validation and submission
        document.getElementById('createTransactionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get form data
            const formData = {
                sellerName: document.getElementById('sellerName').value.trim(),
                sellerPhone: document.getElementById('sellerPhone').value.trim(),
                productName: document.getElementById('productName').value.trim(),
                productDescription: document.getElementById('productDescription').value.trim(),
                amount: parseFloat(document.getElementById('amount').value) || 0,
                notes: document.getElementById('notes').value.trim()
            };
            
            // Clear previous errors
            document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
            document.querySelectorAll('.form-control').forEach(el => el.classList.remove('error'));
            
            // Validate form
            const errors = validateForm(formData);
            
            if (Object.keys(errors).length > 0) {
                // Show errors
                Object.keys(errors).forEach(field => {
                    showFieldError(field, errors[field]);
                });
                return;
            }
            
            // Create transaction
            createTransaction(formData);
        });

        function validateForm(data) {
            const errors = {};
            
            // Seller name
            if (!data.sellerName) {
                errors.sellerName = 'Vui l√≤ng nh·∫≠p t√™n ng∆∞·ªùi b√°n';
            }
            
            // Seller phone
            if (!data.sellerPhone) {
                errors.sellerPhone = 'Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i ng∆∞·ªùi b√°n';
            } else {
                const phoneError = App.Validation.validatePhone(data.sellerPhone);
                if (phoneError) {
                    errors.sellerPhone = phoneError;
                }
            }
            
            // Product name
            if (!data.productName) {
                errors.productName = 'Vui l√≤ng nh·∫≠p t√™n s·∫£n ph·∫©m';
            }
            
            // Amount
            if (!data.amount || data.amount <= 0) {
                errors.amount = 'Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá';
            } else if (data.amount < 10000) {
                errors.amount = 'S·ªë ti·ªÅn t·ªëi thi·ªÉu l√† 10,000 VND';
            }
            
            return errors;
        }

        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const errorElement = document.getElementById(fieldId + 'Error');
            
            if (field && errorElement) {
                field.classList.add('error');
                errorElement.textContent = message;
            }
        }

        function createTransaction(formData) {
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            
            // Show loading
            submitBtn.innerHTML = '‚è≥ ƒêang t·∫°o giao d·ªãch...';
            submitBtn.disabled = true;
            
            // Get current user
            const user = App.User.getCurrentUser();
            
            // Prepare transaction data
            const transactionData = {
                buyerId: user.id,
                buyerName: user.name,
                buyerPhone: user.phone,
                sellerId: 'seller_' + Date.now(), // In real app, this would be looked up
                sellerName: formData.sellerName,
                sellerPhone: formData.sellerPhone,
                productName: formData.productName,
                productDescription: formData.productDescription,
                amount: formData.amount,
                notes: formData.notes
            };
            
            // Simulate API call
            setTimeout(() => {
                try {
                    const transaction = App.Transaction.create(transactionData);
                    
                    // Show success message
                    alert(`Giao d·ªãch ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!\n\nM√£ giao d·ªãch: ${transaction.id}\nTr·∫°ng th√°i: Ch·ªù x√°c nh·∫≠n t·ª´ ng∆∞·ªùi b√°n\n\nB·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o khi ng∆∞·ªùi b√°n x√°c nh·∫≠n.`);
                    
                    // Redirect to transaction detail
                    window.location.href = `transaction-detail.html?id=${transaction.id}`;
                    
                } catch (error) {
                    alert('C√≥ l·ªói x·∫£y ra khi t·∫°o giao d·ªãch. Vui l√≤ng th·ª≠ l·∫°i.');
                    
                    // Restore button
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            }, 2000);
        }

        // Event listeners
        document.getElementById('amount').addEventListener('input', updateAmountDisplay);

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            const user = App.User.getCurrentUser();
            if (user) {
                document.querySelector('.user-name').textContent = user.name;
            }
        });
    </script>
</body>
</html>
