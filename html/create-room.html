<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T·∫°o Ph√≤ng Giao D·ªãch - SafeTrade</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }
        
        .category-option {
            padding: 16px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        
        .category-option.selected {
            border-color: #007BFF;
            background: #e6f3ff;
        }
        
        .category-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .category-name {
            font-size: 14px;
            font-weight: 500;
        }
        
        .room-preview {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-top: 16px;
        }
        
        .preview-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #333;
        }
        
        .preview-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .preview-room-name {
            font-weight: 600;
            color: #333;
        }
        
        .preview-status {
            padding: 4px 8px;
            background: #d4edda;
            color: #155724;
            border-radius: 12px;
            font-size: 12px;
        }
        
        .preview-description {
            color: #666;
            margin-bottom: 12px;
            font-size: 14px;
        }
        
        .preview-stats {
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <button onclick="history.back()" class="btn btn-secondary" style="padding: 8px 12px;">‚Üê</button>
                    <div class="logo" id="pageTitle">T·∫°o Ph√≤ng Giao D·ªãch</div>
                </div>
                <div class="user-info">
                    <div class="user-name">ƒêang t·∫£i...</div>
                    <div class="user-avatar">üè™</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container" style="padding: 24px 16px 80px;">
        <form id="createRoomForm">
            <!-- Room Information -->
            <div class="card mb-24">
                <div class="card-header">
                    <span>üè¢ Th√¥ng tin ph√≤ng giao d·ªãch</span>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">T√™n ph√≤ng *</label>
                        <input type="text" class="form-control" id="roomName" placeholder="Nh·∫≠p t√™n ph√≤ng giao d·ªãch" required>
                        <div class="error-message" id="roomNameError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">M√¥ t·∫£ ph√≤ng *</label>
                        <textarea class="form-control" id="roomDescription" rows="4" placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ ph√≤ng giao d·ªãch, lo·∫°i s·∫£n ph·∫©m, quy ƒë·ªãnh..." required></textarea>
                        <div class="error-message" id="roomDescriptionError"></div>
                    </div>
                </div>
            </div>

            <!-- Category Selection -->
            <div class="card mb-24">
                <div class="card-header">
                    <span>üìÇ Danh m·ª•c s·∫£n ph·∫©m</span>
                </div>
                <div class="card-body">
                    <label class="form-label">Ch·ªçn danh m·ª•c ch√≠nh *</label>
                    <div class="category-grid">
                        <div class="category-option" onclick="selectCategory('electronics')" data-category="electronics">
                            <div class="category-icon">üì±</div>
                            <div class="category-name">ƒêi·ªán t·ª≠</div>
                        </div>
                        <div class="category-option" onclick="selectCategory('fashion')" data-category="fashion">
                            <div class="category-icon">üëï</div>
                            <div class="category-name">Th·ªùi trang</div>
                        </div>
                        <div class="category-option" onclick="selectCategory('home')" data-category="home">
                            <div class="category-icon">üè†</div>
                            <div class="category-name">Gia d·ª•ng</div>
                        </div>
                        <div class="category-option" onclick="selectCategory('books')" data-category="books">
                            <div class="category-icon">üìö</div>
                            <div class="category-name">S√°ch</div>
                        </div>
                        <div class="category-option" onclick="selectCategory('sports')" data-category="sports">
                            <div class="category-icon">‚öΩ</div>
                            <div class="category-name">Th·ªÉ thao</div>
                        </div>
                        <div class="category-option" onclick="selectCategory('other')" data-category="other">
                            <div class="category-icon">üì¶</div>
                            <div class="category-name">Kh√°c</div>
                        </div>
                    </div>
                    <div class="error-message" id="categoryError"></div>
                </div>
            </div>

            <!-- Room Rules -->
            <div class="card mb-24">
                <div class="card-header">
                    <span>üìã Quy ƒë·ªãnh ph√≤ng (t√πy ch·ªçn)</span>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Quy ƒë·ªãnh v√† ƒëi·ªÅu kho·∫£n</label>
                        <textarea class="form-control" id="roomRules" rows="4" placeholder="Nh·∫≠p c√°c quy ƒë·ªãnh, ƒëi·ªÅu kho·∫£n cho ph√≤ng giao d·ªãch (t√πy ch·ªçn)"></textarea>
                    </div>
                    
                    <div style="background: #e3f2fd; padding: 16px; border-radius: 8px; border-left: 4px solid #2196f3;">
                        <h4 style="margin: 0 0 8px 0; color: #1976d2; font-size: 14px;">üí° G·ª£i √Ω quy ƒë·ªãnh:</h4>
                        <ul style="margin: 0; padding-left: 16px; font-size: 13px; color: #1976d2;">
                            <li>Ch·ªâ giao d·ªãch s·∫£n ph·∫©m thu·ªôc danh m·ª•c ƒë√£ ch·ªçn</li>
                            <li>Cung c·∫•p h√¨nh ·∫£nh th·∫≠t c·ªßa s·∫£n ph·∫©m</li>
                            <li>M√¥ t·∫£ ch√≠nh x√°c t√¨nh tr·∫°ng s·∫£n ph·∫©m</li>
                            <li>Giao h√†ng trong v√≤ng 3-5 ng√†y</li>
                            <li>H·ªó tr·ª£ ƒë·ªïi tr·∫£ trong 7 ng√†y</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Preview -->
            <div class="card mb-24" id="roomPreview" style="display: none;">
                <div class="card-header">
                    <span>üëÄ Xem tr∆∞·ªõc</span>
                </div>
                <div class="card-body">
                    <div class="room-preview">
                        <div class="preview-title">Ph√≤ng giao d·ªãch s·∫Ω hi·ªÉn th·ªã nh∆∞ sau:</div>
                        <div class="preview-card">
                            <div class="preview-header">
                                <div class="preview-room-name" id="previewName">T√™n ph√≤ng</div>
                                <div class="preview-status">Ho·∫°t ƒë·ªông</div>
                            </div>
                            <div class="preview-description" id="previewDescription">M√¥ t·∫£ ph√≤ng</div>
                            <div class="preview-stats">
                                <span>üë• 1 th√†nh vi√™n</span>
                                <span>üì¶ 0 giao d·ªãch</span>
                                <span id="previewCategory">üìÇ Danh m·ª•c</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="card">
                <div class="card-body">
                    <button type="submit" class="btn btn-primary btn-full" id="submitBtn">
                        üè¢ T·∫°o Ph√≤ng Giao D·ªãch
                    </button>
                    <button type="button" class="btn btn-secondary btn-full mt-16" onclick="history.back()">
                        H·ªßy b·ªè
                    </button>
                </div>
            </div>
        </form>
    </main>

    <script src="js/app.js"></script>
    <script>
        let selectedCategory = '';
        let isEditMode = false;
        let editingRoomId = null;

        function selectCategory(category) {
            selectedCategory = category;
            
            // Update UI
            document.querySelectorAll('.category-option').forEach(el => {
                el.classList.remove('selected');
            });
            document.querySelector(`[data-category="${category}"]`).classList.add('selected');
            
            updatePreview();
        }

        function updatePreview() {
            const name = document.getElementById('roomName').value.trim();
            const description = document.getElementById('roomDescription').value.trim();
            
            if (name || description || selectedCategory) {
                document.getElementById('roomPreview').style.display = 'block';
                
                document.getElementById('previewName').textContent = name || 'T√™n ph√≤ng';
                document.getElementById('previewDescription').textContent = description || 'M√¥ t·∫£ ph√≤ng';
                
                if (selectedCategory) {
                    const categoryNames = {
                        'electronics': 'üì± ƒêi·ªán t·ª≠',
                        'fashion': 'üëï Th·ªùi trang',
                        'home': 'üè† Gia d·ª•ng',
                        'books': 'üìö S√°ch',
                        'sports': '‚öΩ Th·ªÉ thao',
                        'other': 'üì¶ Kh√°c'
                    };
                    document.getElementById('previewCategory').textContent = categoryNames[selectedCategory] || 'üìÇ Danh m·ª•c';
                }
            } else {
                document.getElementById('roomPreview').style.display = 'none';
            }
        }

        function loadRoomForEdit() {
            const urlParams = new URLSearchParams(window.location.search);
            const roomId = urlParams.get('edit');
            
            if (roomId) {
                isEditMode = true;
                editingRoomId = roomId;
                
                const room = App.Room.getById(roomId);
                if (room) {
                    document.getElementById('pageTitle').textContent = 'Ch·ªânh S·ª≠a Ph√≤ng';
                    document.getElementById('submitBtn').innerHTML = 'üíæ C·∫≠p Nh·∫≠t Ph√≤ng';
                    
                    document.getElementById('roomName').value = room.name;
                    document.getElementById('roomDescription').value = room.description;
                    document.getElementById('roomRules').value = room.rules || '';
                    
                    selectCategory(room.category);
                    updatePreview();
                }
            }
        }

        // Form validation and submission
        document.getElementById('createRoomForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get form data
            const formData = {
                name: document.getElementById('roomName').value.trim(),
                description: document.getElementById('roomDescription').value.trim(),
                category: selectedCategory,
                rules: document.getElementById('roomRules').value.trim()
            };
            
            // Clear previous errors
            document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
            document.querySelectorAll('.form-control').forEach(el => el.classList.remove('error'));
            
            // Validate form
            const errors = validateForm(formData);
            
            if (Object.keys(errors).length > 0) {
                // Show errors
                Object.keys(errors).forEach(field => {
                    showFieldError(field, errors[field]);
                });
                return;
            }
            
            // Create or update room
            if (isEditMode) {
                updateRoom(formData);
            } else {
                createRoom(formData);
            }
        });

        function validateForm(data) {
            const errors = {};
            
            if (!data.name) {
                errors.roomName = 'Vui l√≤ng nh·∫≠p t√™n ph√≤ng';
            } else if (data.name.length < 5) {
                errors.roomName = 'T√™n ph√≤ng ph·∫£i c√≥ √≠t nh·∫•t 5 k√Ω t·ª±';
            }
            
            if (!data.description) {
                errors.roomDescription = 'Vui l√≤ng nh·∫≠p m√¥ t·∫£ ph√≤ng';
            } else if (data.description.length < 20) {
                errors.roomDescription = 'M√¥ t·∫£ ph·∫£i c√≥ √≠t nh·∫•t 20 k√Ω t·ª±';
            }
            
            if (!data.category) {
                errors.category = 'Vui l√≤ng ch·ªçn danh m·ª•c';
            }
            
            return errors;
        }

        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const errorElement = document.getElementById(fieldId + 'Error');
            
            if (field && errorElement) {
                field.classList.add('error');
                errorElement.textContent = message;
            }
        }

        function createRoom(formData) {
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            
            // Show loading
            submitBtn.innerHTML = '‚è≥ ƒêang t·∫°o ph√≤ng...';
            submitBtn.disabled = true;
            
            // Get current user
            const user = App.User.getCurrentUser();
            
            // Prepare room data
            const roomData = {
                ...formData,
                ownerId: user.id,
                ownerName: user.name
            };
            
            // Simulate API call
            setTimeout(() => {
                try {
                    const room = App.Room.create(roomData);
                    
                    // Show success message
                    alert(`Ph√≤ng giao d·ªãch ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!\n\nM√£ ph√≤ng: ${room.id}\nT√™n ph√≤ng: ${room.name}\n\nB·∫°n c√≥ th·ªÉ b·∫Øt ƒë·∫ßu m·ªùi th√†nh vi√™n tham gia.`);
                    
                    // Redirect to rooms page
                    window.location.href = 'rooms.html';
                    
                } catch (error) {
                    alert('C√≥ l·ªói x·∫£y ra khi t·∫°o ph√≤ng. Vui l√≤ng th·ª≠ l·∫°i.');
                    
                    // Restore button
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            }, 2000);
        }

        function updateRoom(formData) {
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            
            // Show loading
            submitBtn.innerHTML = '‚è≥ ƒêang c·∫≠p nh·∫≠t...';
            submitBtn.disabled = true;
            
            // Simulate API call
            setTimeout(() => {
                try {
                    App.Room.update(editingRoomId, formData);
                    
                    alert('Ph√≤ng giao d·ªãch ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng!');
                    window.location.href = 'rooms.html';
                    
                } catch (error) {
                    alert('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t ph√≤ng. Vui l√≤ng th·ª≠ l·∫°i.');
                    
                    // Restore button
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            }, 1500);
        }

        // Event listeners
        document.getElementById('roomName').addEventListener('input', updatePreview);
        document.getElementById('roomDescription').addEventListener('input', updatePreview);

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            const user = App.User.getCurrentUser();
            if (user) {
                document.querySelector('.user-name').textContent = user.name;
                loadRoomForEdit();
            }
        });
    </script>
</body>
</html>
